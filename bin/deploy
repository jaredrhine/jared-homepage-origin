#!/bin/bash

set -xe

SERVICE=jared-homepage-origin
PORT=8998
VERSION=v21
TARBALL=$SERVICE.$VERSION.tar

# Rerun the build of the web app

cd /home/jared/work/home/jared-homepage-vue/homeapp
npm run build

# Refresh the local copy of the static file build, since Dockerfile
# can't copy from outside the build context. This is the
# cheap-and-easy way to handle that issue, by copying them here.

cd /home/jared/work/home/jared-homepage-origin
rm -rf site
mkdir site
cp -a /home/jared/work/home/jared-homepage-vue/homeapp/dist/* site/

# Build docker container into a file

docker buildx build -t $SERVICE:$VERSION .
docker save -o $TARBALL $SERVICE:$VERSION

# Load the image

docker -H ssh://mongoose image load -i $TARBALL

# Create and start the container

CONTAINER=$(docker -H ssh://mongoose container create --name $SERVICE -p $PORT:80 $SERVICE:$VERSION)
docker -H ssh://mongoose start $CONTAINER

# Remove the docker build artifact

rm -f $TARBALL
